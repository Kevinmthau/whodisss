# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Whodisss is an iOS app built with SwiftUI that helps users add profile photos to their contacts. The app provides three methods for adding photos:
1. Search Google Images via embedded web view
2. Choose from photo library using PhotosPicker
3. Take photos using device camera

## Architecture

The project follows **MVVM (Model-View-ViewModel)** pattern with clear separation of concerns:

### Core Structure
- **Models/** - `ContactInfo` data model wrapping CNContact with computed properties
- **Services/** - Protocol-based services for Contacts framework (`ContactStore`) and image operations (`ImageService`)
- **ViewModels/** - State management and business logic (`ContactsViewModel`, `ContactDetailViewModel`, `ImageSearchViewModel`, `PhotoEditorViewModel`)
- **Views/** - SwiftUI views organized by feature (Contacts/, Camera/, ImageSearch/, PhotoEditor/, Components/)

See ARCHITECTURE.md for detailed component breakdown.

### Data Flow
1. App requests Contacts access via `ContactsViewModel` → `ContactStore`
2. Contacts fetched on background thread via `Task.detached`, UI updates via `@Published`
3. Photo selection: ContactDetailView → ActiveSheet enum → single `.sheet(item:)` modifier
4. Image processing: Download/Select → Interactive Crop (PhotoEditorView) → Compress (0.8 JPEG) → Save

### Critical Implementation Details

#### Sheet Management
- **MUST use single `.sheet(item:)` with `ActiveSheet` enum** - Multiple `.sheet` modifiers cause crashes
- ActiveSheet enum states: `imageSearch`, `camera`, `photoEditor(UIImage)`
- Delay sheet transitions with `DispatchQueue.main.asyncAfter(deadline: .now() + 0.5)`
- Handle selectedImage state across sheet transitions

#### Photo Picker Reset
- **Always set `photoPickerItem = nil` after processing** to allow repeat selections

#### Google Images Integration
- WKWebView with JavaScript injection on page load
- JavaScript intercepts all clicks, searches for images in DOM
- Downloads image via URLSession before presenting PhotoEditorView

#### PhotoEditor Implementation
- **Interactive Crop View**: 240px circular mask with white border
- **Pinch-to-Zoom**: Scale range 1.0x to 5.0x using `MagnificationGesture`
- **Pan/Drag**: Free movement with `DragGesture` and `@GestureState` for temporary offsets
- **Simultaneous Gestures**: Combined zoom and pan using `SimultaneousGesture`
- **Dual Crop Methods**: 
  - Basic: `cropImageToSquare(_ image:)` for center crop
  - Advanced: `cropImageToSquare(_ image:, scale:, offset:)` for interactive crop

#### Image Processing Pipeline
```swift
// Interactive crop with transforms
UIGraphicsBeginImageContextWithOptions(outputSize, false, image.scale)
context.translateBy(x: outputSize.width / 2, y: outputSize.height / 2)
context.translateBy(x: offset.width, y: offset.height)
context.scaleBy(x: scale, y: scale)
// Draw with aspect ratio preservation
```

#### Threading
- `@MainActor` on ViewModels for UI safety
- Contact enumeration uses `Task.detached` for background processing
- Image crop operations run async with `Task.detached` to prevent UI blocking

## Development Commands

### Build & Run
```bash
# Build for simulator
xcodebuild -project whodisss.xcodeproj -scheme whodisss -destination 'generic/platform=iOS Simulator' build

# Build for physical device (replace with your device name)
xcodebuild -project whodisss.xcodeproj -scheme whodisss -destination 'platform=iOS,name=iPhone 16 Pro' build

# Archive for TestFlight
xcodebuild archive -project whodisss.xcodeproj -scheme whodisss -destination "generic/platform=iOS" -archivePath ~/Library/Developer/Xcode/Archives/whodisss.xcarchive

# Run tests
xcodebuild test -project whodisss.xcodeproj -scheme whodisss -destination 'platform=iOS Simulator,name=iPhone 16 Pro'
```

### TestFlight Deployment
1. Increment `CURRENT_PROJECT_VERSION` in project.pbxproj
2. Archive and export with `method: app-store-connect`
3. Upload happens automatically with `xcodebuild -exportArchive`

## Build Configuration
- Bundle ID: `com.mushpot.whodisss`
- Team ID: `3JXY2MS2Y3`
- Deployment Target: iOS 18.5
- Version: 1.0 (Build 2)

## Privacy Permissions Required
Info.plist keys (auto-generated by Xcode):
- `NSContactsUsageDescription` - Access contacts to add photos
- `NSCameraUsageDescription` - Take photos for contacts
- `NSPhotoLibraryUsageDescription` - Select photos from library

## Known Issues & Solutions

### Camera on Simulator
Camera features don't work on simulator - test on physical device. Warnings about "BackTriple device" are normal and can be ignored.

### Device Console Warnings
Normal warnings when debugging on physical device:
- "Failed to find a valid fallback video configuration" - Camera mode switching on iPhone Pro models
- "Hang detected" messages - Brief pauses during debugging, not actual hangs
- Web browser engine errors - Related to WKWebView, doesn't affect functionality

### Pull-to-Refresh
Simple manual refresh only - no background monitoring. Implementation:
```swift
.refreshable { await viewModel.refreshContacts() }
```

## Testing Notes
- Unit tests use Swift Testing framework (not XCTest)
- UI tests use traditional XCTest
- Camera functionality requires physical device